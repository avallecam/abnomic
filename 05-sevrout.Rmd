---
title: "Covariates: table 1 + table 2"
author: "Andree Valle Campos"
date: '`r Sys.Date()`'
output:
  html_document:
  #pdf_document:
  # html_notebook:
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
    #theme: united
    code_folding: "hide"
    #fig_caption: TRUE
    #number_sections: TRUE
bibliography: malaria.bib
link-citations: yes
#csl: american-medical-association.csl
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, #fig.path = "01-",
                      warning = FALSE,message = FALSE)
# knitr::opts_knit$set(root.dir = '../.')
options(width = 90) # expand limits of CONSOLE output
```

## To-do

- (x) remover glimpse
- (x) retirar parasitemia sin mil
- (x) minimalizar formato
- ( ) save input to xls

## Packages

```{r}
library(tidyverse)
library(compareGroups)
library(magrittr)
```

## Data input

```{r}
sevdb_2ws <- read_rds("data/03-sevrcov-228obs_21var.rds") %>% janitor::clean_names()
# sevdb_2ws %>% glimpse()
```

```{r}
sevdb_3sv <- read_rds("data/03-sevrcov.rds") %>% janitor::clean_names()
# sevdb_3sv %>% glimpse()
```

## Select variables

```{r,warning=FALSE,message=FALSE}
sevdb_2ws_clean <- sevdb_2ws %>% 
  mutate(edad_4=Hmisc::cut2(edad,g = 4),
         enf_sum=as.factor(enf_sum)) %>% 
  cdcper::cdc_edades_peru() %>% 
  #start select
  select(-(edad_grupo_x:edad_inei_grupos_labels),
         -edad_etapas_de_vida_t,
         -(sev_who_num_1:sev_who_num_4),
         -(sev_who_1:sev_who_4),
         -shock_oms_pa) %>% 
  select(starts_with("edad"),
         sexo:enf_sum,
         tx_par_intest,
         parasitemia_mil,parasitemia_mil_4,
         en_zona_endemica,en_zona_endemica_4,
         episodio_previo,
         everything()) %>% 
  select(-parasitemia)

sevdb_2ws_clean %>% glimpse()
```

## Table 1 - all

```{r}
tab01all <- sevdb_2ws_clean %>% 
  # extract edad quartiles
  select(-edad_4) %>% 
  compareGroups(study~.,data = .,
                method = c(edad=2,
                           en_zona_endemica=2,
                           episodio_previo_num=2,
                           parasitemia_mil=2)) %>% 
  createTable(digits = 1,
              sd.type = 2,
              show.n = T,
              show.all = T)

tab01all %>% export2md() 
tab01all %>% export2xls("table/05-tab01-all_covariates.xls")
  
```

## Table 1 - oms criteria

```{r}
tab01oms <- sevdb_2ws_clean %>% 
  # extract edad quartiles
  select(-edad_4) %>% 
  # extract variables
  select(anemia_oms:convulsion,
         sev_who_num,
         study) %>% 
  compareGroups(study~.,data = .#,
                # method = c(edad=2,
                #            en_zona_endemica=2,
                #            episodio_previo_num=2,
                #            parasitemia_mil=2)
                ) %>% 
  createTable(digits = 1,
              sd.type = 2,
              show.n = T,
              show.all = T)

tab01oms %>% export2md() 
tab01oms %>% export2xls("table/05-tab01-oms_covariates.xls")
```


## Table 2

```{r}

```


## Figures

```{r}
sevdb_2ws_clean %>% 
  ggplot(aes(x = edad)) +
  geom_histogram(binwidth = 1)

sevdb_2ws_clean %>% 
  ggplot(aes(x = parasitemia_mil)) +
  geom_histogram(binwidth = 1)

sevdb_2ws_clean %>% 
  ggplot(aes(x = en_zona_endemica)) +
  geom_histogram(binwidth = 1)

sevdb_2ws_clean %>% 
  ggplot(aes(x = episodio_previo_num)) +
  geom_histogram(binwidth = 1)
```


```{r}
sevdb_2ws_clean %>% 
  filter(!is.na(edad)) %>%
  ggplot(aes(x = edad_4)) +
  geom_bar(aes(fill=sev_who),position = position_fill()) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

sevdb_2ws_clean %>% 
  # filter(!is.na(edad)) %>%
  ggplot(aes(x = parasitemia_mil_4)) +
  geom_bar(aes(fill=sev_who),position = position_fill()) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

sevdb_2ws_clean %>% 
  # filter(!is.na(edad)) %>%
  ggplot(aes(x = en_zona_endemica_4)) +
  geom_bar(aes(fill=sev_who),position = position_fill()) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
sevdb_2ws_clean %>% 
  filter(!is.na(edad)) %>%
  count(edad_4,sev_who) %>% 
  pivot_wider(names_from = sev_who,values_from = n) %>% 
  mutate(denominator=no_severo+severo) %>% 
  mutate(raw=pmap(.l = select(.,x=severo,n=denominator),
                    .f = binom.test),
           raw=map(.x = raw,.f = broom::tidy)) %>%
    unnest(raw) %>% 
  select(1:5,starts_with("conf")) %>% 
  ggplot(aes(x = edad_4,y = estimate)) +
  geom_point() +
  geom_errorbar(aes(max=conf.high, min = conf.low)) +
  ylim(0,1)
```
