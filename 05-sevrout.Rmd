---
title: "Covariates: table 1 + table 2"
author: "Andree Valle Campos"
date: '`r Sys.Date()`'
output:
  html_document:
  #pdf_document:
  # html_notebook:
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
    #theme: united
    code_folding: "hide"
    #fig_caption: TRUE
    #number_sections: TRUE
bibliography: malaria.bib
link-citations: yes
#csl: american-medical-association.csl
editor_options: 
  chunk_output_type: console
params:
  spanish: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, #fig.path = "01-",
                      warning = FALSE,message = FALSE)
# knitr::opts_knit$set(root.dir = '../.')
options(width = 90) # expand limits of CONSOLE output
```

## To-do

- (x) tabla 1 - copy to google sheets
- (o) tabla 2 - copy to google sheets

## Packages

```{r}
library(tidyverse)
library(compareGroups)
```

## Data input

```{r}
sevdb_2ws <- read_rds("data/03-sevrcov-228obs_21var.rds") %>% janitor::clean_names()
# sevdb_2ws %>% glimpse()
```

```{r,eval=FALSE}
sevdb_3sv <- read_rds("data/03-sevrcov.rds") %>% janitor::clean_names()
# sevdb_3sv %>% glimpse()
```

## Select variables

```{r,warning=FALSE,message=FALSE}
sevdb_2ws_notranslation <- sevdb_2ws %>% 
  mutate(edad_4=Hmisc::cut2(edad,g = 4),
         enf_sum=as.factor(enf_sum)) %>% 
  cdcper::cdc_edades_peru(variable_edad = edad) %>% 
  mutate(episodio_previo_cat = Hmisc::cut2(episodio_previo_num,g = 4)) %>% 
  #start select
  select(-(edad_grupo_x:edad_inei_grupos_labels),
         -edad_etapas_de_vida_t,
         -(sev_who_num_1:sev_who_num_4),
         -(sev_who_1:sev_who_4),
         -shock_oms_pa) %>% 
  select(starts_with("edad"),
         sexo:enf_sum,
         tx_par_intest,
         parasitemia_mil,parasitemia_mil_4,
         en_zona_endemica,en_zona_endemica_4,
         episodio_previo_num,
         episodio_previo_cat,
         episodio_previo,
         everything()) %>% 
  select(-parasitemia) %>% 
  select(starts_with("edad"),sexo,
         glas_oms,convulsion,
         shock_oms,pulmonar_oms,
         renal_oms,hipoglic_oms,
         anemia_oms,hiperbil_oms,
         everything()) %>% 
  select(-tx_par_intest) %>% 
  select(-sangr_oms,-trombo_sev,-presenta_comorb,-casecontrol) %>% 
  mutate(edad_etapas_de_vida_c=fct_recode(edad_etapas_de_vida_c,
                                          "0-11"="0_11a",
                                          "12-17"="12_17a",
                                          "18-29"="18_29a",
                                          "30-59"="30_59a",
                                          "60+"="60a_mas"))
```

```{r}
sevdb_2ws_clean <- sevdb_2ws_notranslation %>% 
  # per language
  # add variable labels
  labelled::set_variable_labels(
    edad="Age (years)",
    edad_etapas_de_vida_c="Age groups",
    sexo="Sex",
    shock_oms="Shock (systolic blood pressure < 80 mmHg)",
    glas_oms="Coma (Glasgow score <= 9/14)",
    pulmonar_oms="Lung injury (ARDS or pulmonary edema)",
    anemia_oms="Severe anemia (hemoglobin < 7 g/dL)",
    renal_oms="Acute renal failure (creatinine > 3 mg/dL)",
    hiperbil_oms="Hyperbilirubinemia (bilirubin > 2.5 mg/dL)", #Jaundice
    hipoglic_oms="Hypoglycemia (glucose < 40 mg/dL)",
    convulsion="Convulsion",
    # presenta_comorb="Comorbidity",
    enf_cronica="Chronic disease",
    enf_sum = "Multiple chronic diseases",
    parasitemia_mil="Parasite density (x 1000 par/uL)",
    en_zona_endemica="Time in endemic area (years)",
    episodio_previo_num="Previous episodes (number)",
    episodio_previo_cat="Previous episodes (range)",
    sev_who_num="Severe malaria criteria (number)",
    sev_who="Severe malaria",
    study="Protein microarray study",
    episodio_previo="Previous episodes") %>% 
  # # add value levels
  # # problem: do not work on factor variables
  # # additionally: only variable labels work, not variable values
  # labelled::set_value_labels(
  #   study = c("No"="whole-db","Yes"="in-microarray")
  # ) %>% 
  mutate(across(.cols = c(glas_oms:hiperbil_oms,
                          # presenta_comorb,
                          enf_cronica),
                .fns = ~fct_recode(.,"No"="0","Yes"="1"))) %>% 
  mutate(episodio_previo=fct_recode(episodio_previo,
                                    "Without"="sin",
                                    "With"="con")) %>% 
  mutate(sexo=fct_recode(sexo,
                         "Male"="masculino",
                         "Female"="femenino")) %>% 
  mutate(sev_who=fct_recode(sev_who,
                         "No"="no_severo",
                         "Yes"="severo")) #%>% 
  # mutate(study=fct_recode(study,
  #                        "No"="whole-db",
  #                        "Yes"="in-microarray"))
```

```{r,eval=params$spanish}
sevdb_2ws_clean <- sevdb_2ws_notranslation %>% 
  # per language
  # add labels
  labelled::set_variable_labels(
    edad="Edad (años)",
    edad_etapas_de_vida_c="Edad (grupos)",
    sexo="Sexo",
    shock_oms="Shock (presión arterial sistólica < 80 mmHg)",
    glas_oms="Coma (puntaje Glasgow <= 9/14)",
    pulmonar_oms="Lesión pulmonar (SDRA o edema pulmonar)",
    anemia_oms="Anemia grave (hemoglobina < 7 g/dL)",
    renal_oms="Insuficiencia renal aguda (creatinina > 3 mg/dL)",
    hiperbil_oms="Hiperbilirrubinemia (bilirrubina > 2,5 mg/dL)", #Jaundice
    hipoglic_oms="Hipoglicemia (glucosa < 40mg/dL)",
    convulsion="Convulsión",
    #presenta_comorb="Comorbilidad",
    enf_cronica="Enfermedad crónica",
    enf_sum="Múltiples enfermedades crónicas",
    parasitemia_mil="Densidad de parásitos (x 1000 par/uL)",
    en_zona_endemica="Tiempo en zona endémica (años)",
    episodio_previo_num="Episodios anteriores (número)",
    episodio_previo_cat="Episodios anteriores (rangos)",
    sev_who_num="Criterios de Malaria severa (número)",
    sev_who="Malaria severa",
    study="Estudio con microarreglos de proteinas",
    episodio_previo="Episodios anteriores") %>% 
  # replace levels
  mutate(across(.cols = c(glas_oms:hiperbil_oms,
                          # presenta_comorb,
                          enf_cronica),
                .fns = ~fct_recode(.,"No"="0","Sí"="1"))) %>% 
  mutate(episodio_previo=fct_recode(episodio_previo,
                                    "Sin"="sin",
                                    "Con"="con")) %>% 
  mutate(sexo=fct_recode(sexo,
                         "Masculino"="masculino",
                         "Femenino"="femenino")) %>% 
  mutate(sev_who=fct_recode(sev_who,
                         "No"="no_severo",
                         "Sí"="severo")) #%>% 
  # mutate(study=fct_recode(study,
  #                        "No"="whole-db",
  #                        "Sí"="in-microarray"))
```

```{r}
sevdb_2ws_clean %>% glimpse()
```


## Table 1 - all covariates

```{r}
tab01all <- sevdb_2ws_clean %>% 
  # extract edad quartiles
  select(-edad_4) %>% 
  select(-parasitemia_mil_4,
         -en_zona_endemica_4) %>% 
  compareGroups(study~.,data = .,
                method = c(edad=2,
                           en_zona_endemica=2,
                           episodio_previo_num=2,
                           parasitemia_mil=2)) %>% 
  createTable(digits = 1,
              sd.type = 2,
              show.n = T,
              show.all = T)

tab01all %>% export2md() 
tab01all %>% export2xls("table/05-tab01-all_covariates.xls")
  
```

## Table 1 - oms criteria

```{r}
tab01oms <- sevdb_2ws_clean %>% 
  # extract edad quartiles
  select(-edad_4) %>% 
  select(-parasitemia_mil_4,
         -en_zona_endemica_4) %>% 
  # extract variables
  select(glas_oms:hiperbil_oms,
         sev_who_num,
         study) %>% 
  compareGroups(study~.,data = .,
                chisq.test.perm = TRUE,
                # method = c(edad=2,
                #            en_zona_endemica=2,
                #            episodio_previo_num=2,
                #            parasitemia_mil=2)
                ) %>% 
  createTable(digits = 1,
              sd.type = 2,
              show.n = T,
              show.all = T)

tab01oms %>% export2md() 
tab01oms %>% export2xls("table/05-tab01-oms_covariates.xls")
```


## Table 2 - all observations

```{r}
tab02all <- sevdb_2ws_clean %>% 
  # extract edad quartiles
  select(-edad_4) %>% 
  select(-parasitemia_mil_4,
         -en_zona_endemica_4) %>% 
  # extract variables
  select(-(glas_oms:hiperbil_oms),
         # -(sangr_oms:trombo_sev),
         -enf_sum,
         -sev_who_num,
         # -casecontrol,
         -study) %>% 
  compareGroups(sev_who~.,data = .,
                byrow = F,
                method = c(edad=2,
                           en_zona_endemica=2,
                           episodio_previo_num=2,
                           parasitemia_mil=2)) %>% 
  createTable(digits = 1,
              sd.type = 2,
              show.n = T,
              show.all = T)

tab02all %>% export2md() 
tab02all %>% export2xls("table/05-tab02-all_observations.xls")
  
```

## Table 2 - microarray study

```{r}
tab02abn <- sevdb_2ws_clean %>% 
  # filter observations
  filter(study=="in-microarray") %>% 
  # extract edad quartiles
  select(-edad_4) %>% 
  select(-parasitemia_mil_4,
         -en_zona_endemica_4) %>% 
  # extract variables
  select(-(glas_oms:hiperbil_oms),
         # -(sangr_oms:trombo_sev),
         -enf_sum,
         -sev_who_num,
         # -casecontrol,
         -study) %>% 
  compareGroups(sev_who~.,data = .,
                byrow = F,
                method = c(edad=2,
                           en_zona_endemica=2,
                           episodio_previo_num=2,
                           parasitemia_mil=2)) %>% 
  createTable(digits = 1,
              sd.type = 2,
              show.n = T,
              show.all = T)

tab02abn %>% export2md() 
tab02abn %>% export2xls("table/05-tab02-abn_observations.xls")
  
```


<!-- ```{r} -->
<!-- sevdb_2ws_clean %>%  -->
<!--   # extract edad quartiles -->
<!--   select(study,sev_who) %>%  -->
<!--   compareGroups(study~.,data = ., -->
<!--                 byrow = T) %>%  -->
<!--   createTable(digits = 1, -->
<!--               sd.type = 2, -->
<!--               show.n = T, -->
<!--               show.all = T) -->
<!-- ``` -->


## Figures

```{r}
sevdb_2ws_clean %>% 
  ggplot(aes(x = edad)) +
  geom_histogram(binwidth = 1)

sevdb_2ws_clean %>% 
  ggplot(aes(x = parasitemia_mil)) +
  geom_histogram(binwidth = 1)

sevdb_2ws_clean %>% 
  ggplot(aes(x = en_zona_endemica)) +
  geom_histogram(binwidth = 1)

sevdb_2ws_clean %>% 
  ggplot(aes(x = episodio_previo_num)) +
  geom_histogram(binwidth = 1)
```


```{r}
sevdb_2ws_clean %>% 
  filter(!is.na(edad)) %>%
  ggplot(aes(x = edad_4)) +
  geom_bar(aes(fill=sev_who),position = position_fill()) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

sevdb_2ws_clean %>% 
  # filter(!is.na(edad)) %>%
  ggplot(aes(x = parasitemia_mil_4)) +
  geom_bar(aes(fill=sev_who),position = position_fill()) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

sevdb_2ws_clean %>% 
  # filter(!is.na(edad)) %>%
  ggplot(aes(x = en_zona_endemica_4)) +
  geom_bar(aes(fill=sev_who),position = position_fill()) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
sevdb_2ws_clean %>% 
  filter(!is.na(edad)) %>%
  count(edad_4,sev_who) %>% 
  pivot_wider(names_from = sev_who,values_from = n) %>% 
  rowwise() %>% 
  mutate(denominator=sum(c_across(cols = -edad_4))) %>% 
  ungroup() %>% 
  mutate(raw=pmap(.l = select(.,x=3,n=denominator), #cuidado
                    .f = binom.test),
           raw=map(.x = raw,.f = broom::tidy)) %>%
    unnest(raw) %>% 
  select(1:5,starts_with("conf")) %>% 
  ggplot(aes(x = edad_4,y = estimate)) +
  geom_point() +
  geom_errorbar(aes(max=conf.high, min = conf.low)) +
  ylim(0,1)
```

## Additional 

```{r}
read.csv("data-raw/RawData.csv") %>% 
  as_tibble() %>% 
  pivot_longer(cols = -(Index:Description),names_to = "samples",values_to = "array_read") %>% 
  select(samples) %>% 
  distinct() %>% 
  mutate(precode=str_replace(samples,"(...).+","\\1")) %>% 
  dplyr::count(precode)
```

```{r}
readr::read_csv("data-raw/ADi-NAMRU6_Data-samples.csv") %>% 
  # glimpse()
  dplyr::count(Study,Sample.Type)

readr::read_csv("data-raw/ADi-NAMRU6_Data-samples.csv") %>% 
  filter(Study=="Controls")

readr::read_csv("data-raw/samples.csv") %>% 
  dplyr::count(Sample.Type)
```

