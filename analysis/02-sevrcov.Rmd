---
title: "COVARIATES (previous: nov2014.dta)"
author: "Andree Valle Campos"
date: '`r Sys.Date()`'
output:
  #html_notebook:
  html_document:
    fig_caption: yes
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: yes
    code_folding: "hide"
    #df_print: paged
bibliography: malaria.bib
#csl: american-medical-association.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, #fig.path = "01-",
                      warning = FALSE)
knitr::opts_knit$set(root.dir = '../.')

options(width = 110) # expand limits of CONSOLE output

require(Hmisc)
mu <- markupSpecs$html   # markupSpecs is in Hmisc
# hidden command (<code>r mu$widescreen()</code>) to use an entire wide screen. # mu$widescreen()
```
`r mu$widescreen()`

# Aim

Retrieve relevant variables from the *Severe Vivax Malaria study* 
to use them as covariates for the subset of samples provided to the 
*Protein microarray Ab profile study*.

# Done

- **new** variables: 
    + `glas_11`: Glasgow score lower than 11 (and different from 0)
    + `sev_WHO_num`: Number of Severe Malaria WHO criterias of the patient
    + `sev_WHO`: Absence or presence of Severe Malaria WHO criterias of the patient
- `glas_11` [here](#tidy-data):
    + Glasgow < 11 & !=0
    + **differs** from `cns_malaria`
- `sev_WHO` [here](#filter-who-criteria):
    + **includes:** 
        + `glas_11`, `sdra`, `lung_injury`, `ictericia_corr`, `hiperbil`, `shock`, 
        `bleeding`, `glic_normal`, `hiperparasitemia`, `anemia_severa`.
    + **Not** included `cns_malaria`
    + **differs** from `cas_con_admin2`
- Inferential statistics [here](#inferential-statistics) (exploratory):
    + given a stratification, the following variables were significatly different:
        + **`sev_WHO`**: proportion of `sex` and `malaria_pasado`
        + **`malaria_pasado`**: mean `age` and proportion of `sev_WHO`
- Ab profile subset of **60 samples** [here](#ab-profile-subset) :
    + frequency tables with respect to severity, previous episodes and combined.

# To do

- **review** new variables `glas_11` and `sev_WHO`
- `sev_WHO`:
    + **include** as **renal impairment / failure criteria** `hemoglobinuria_corr` or `oliguria_corr`?
    + **meaning** of `cas_con_admin2`?
- **change** `NA` to `0` among severe [covariates](#proportions-per-criteria)?

# Notes

- From this dataset:
    + Since all the cases were reported in a Hospital, can all patients be considered symptomatic?
    + Although the proportion of `malaria_pasado` significatly differs w.r.t. `sev_WHO`,
    *previous episodes of malaria* may not be directly associated with `sev_WHO`.
    + Continuous Exposure (rather than previous reported cases of malaria) could be 
    a *conditional* factor to achieve immunity (asympomatic),
    but it may not be *determinant* to protect against severity.

- `malaria_pasado` limitations:
    + is self-reported.
    + is not exposure.
    + could be validated/improved with MSP1 ELISA quantification.
    + more relevant would be to take into account *time since last exposure (or malaria event)* 
    in a follow-up longitudinal study.

# Analysis

## Dependencies
```{r, message=FALSE}
##essential
library("tidyverse")  # load dplyr, tidyr, tibble, readr, purr, ggplot2
library("haven")      # import STATA .dta files
library("Hmisc")      # Data dictionary + descriptive / stratified statistics
##extra
library("forcats")    # factor vectors
library("stringr")    # for strings
library("knitr")      # To display nice tables
library("Rmisc")      # multiplot ggplots
library("viridis")    # color visualization

```

## Severe dataset

### Initial comparison

```{r}
a <- haven::read_dta("data-raw/malaria severa 28Nov2014_Ed.dta") #%>% haven::as_factor() #ERROR
b <- haven::read_dta("data-raw/severe_malaria_vivax SEP2016.dta") #%>% haven::as_factor() #ERROR

intersect(a[,"codigo"], b[,"codigo"])
setdiff(a[,"codigo"], b[,"codigo"])
setdiff(b[,"codigo"], a[,"codigo"])
```


### Input

- Read `severe_malaria_vivax SEP2016.dta` file: 

```{r}
sevdb <- haven::read_dta("data-raw/malaria severa 28Nov2014_Ed.dta") #%>% haven::as_factor() #ERROR
```

### Data dictionary

- Including the **labels** from the `.dta` file:

```{r}
#Hmisc::contents(sevdb)
html(Hmisc::contents(sevdb), maxlevels=10, levelType='table')
#sevdb %>% select(contains("fiebre")) %>% group_by(fiebre_hoy_corr,fiebre_us_corr) %>% dplyr::count()
```

### Tidy data

- **create** `glas_11` 
    + Glasgow < 11 & !=0
    + **differs** from `cns_malaria`

- sobre `fiebre`: preferencia en `_hoy_corr`

- hay variable `coinfections`?

#### issues (28nov2014.dta)

__criterios de inclusión__

* clínicos

    - shock circulatorio (presión sanguínea sistólica < 80 mmHg): "shock", "parterial", ~~"fcardiaca"~~
    - glasgow (puntaje Glasgow $\le$ 9/14): "glas_ojos", "glas_verbal", "glas_motor", "glasgow"
    - daño en SNC: "postracion", "confusion", "coma", "convulsion", "snc_normal" 
    - SDRA: "sdra"
    - daño pulmonar: "disnea", "taquipnea", "infiltracion", "edema_pulm", "resp_normal", ~~"frespiratoria"~~
    - ~~sangrado: "sangrado", "gingivorragia", "epistaxis", "sang_intest"~~ 
    - ~~trombocitopenia: "trombocitopenia", "cont_plaquetas", "coag_normal"~~
    - ~~parasitemia:  "eritro_parasit", "hiperparasitemia", "erit_asex", "cien_paras", "parasitemia"~~
    - ~~temperatura: "hiperpirexia", "temperatura"~~
    - ~~UCI: "admin_uci", "dias_uci"~~

* laboratorio

    - hipoglicemia (glucosa < 40 mg/dL): "glucosa", "glic_normal", "hipo_glic1", "hipo_glic2"
    - anemia severa (hemoglobina < 7mg/dL): "hemoglobinuria", "anemia_severa", "hto_bajo", "hemog_bajo", "hto", "hemoglobina"
    - daño renal (creatinina > 3mg/dl): "creatinina", "renal_normal", "hipercreat", "creatin_valor", "oliguria"
    - hiperbilirrubina (bilirrubina sérica > 2.5 mg/dL).: "hepato_normal", "ictericia", "hiperbil", "bilirrubina", "bilitot", "bilind", "bildirect"

__criterios de exclusión__

- mono-infecciones: `?`
- coinfección: `?`

__condicionantes__

- exposición: "malaria_pasado_num", "tx_pasado", "tx_pasado_num", "malaria_falc", "busco_tx", "tx_malaria"

- comorbilidad: "presenta_comorb", "sin_enf_cronica", "diabetes", "enf_snc", "enf_snc_esp", "enf_pulm", "enf_pulm_esp", "enf_cardiac", "enf_cardiac_esp", "enf_renal", "enf_renal_esp", "enf_otra", "enf_otra_esp"

__clasificación__

- paciente severo: "cas_con_admin", "criticos", "cerebral2", "criticalnopros", "casecontrol", "dx_admin"

```{r}
# NO creatinina -> ???
# NO parasitemia -> hiperparasitemia
sevdb_1 <- sevdb %>% 
  select(codigo,
         cas_con_admin,
         edad, sexo,
         #ident_caso:dx_admin6, 
         #-starts_with("dx_admin"), -ident_caso, -contains("smear"), -eritro_parasit,
         admin_uci:peso,
         -numconvul, -dias_uci, #-starts_with("glas_"),
         -hiperpirexia, -temperatura, -fcardiaca, frespiratoria,
         #-ends_with("_us"), -inicio_sintom_fec, -ends_with("_hoy"),
         #-starts_with("droga"), 
         malaria_pasado_num, #malaria_pasado_num:tx_malaria, -starts_with("notx_"), -starts_with("donde_"),
         presenta_comorb:enf_otra_esp, -ends_with("_esp"), -contains("otra"),
         parasitemia, 
         glucosa:casecontrol
         #-starts_with("fec_tx_"), -starts_with("tx_"), #-starts_with("notx_"),
         #starts_with("preg_"),
         #fuente_agua:trabajo_riesgo, #vinculadas a riesgo/exposición
         ) %>% 
  tidyr::separate(parterial, c("pa_sistolica", "pa_diastolica")) %>% 
  mutate(codigo= str_replace(codigo,"LIM0","LIM"),
         
         pa_sistolica= str_replace(pa_sistolica,"NaN|99",replacement = NA_character_),
         pa_diastolica= str_replace(pa_diastolica,"NaN|99",replacement = NA_character_),
         shock= str_replace(shock,"NaN|99",replacement = NA_character_),
         sdra= str_replace(sdra,"NaN|99",replacement = NA_character_),
         postracion= str_replace(postracion,"NaN|99",replacement = NA_character_),
         confusion= str_replace(confusion,"NaN|99",replacement = NA_character_),
         coma= str_replace(coma,"NaN|99",replacement = NA_character_),
         convulsion= str_replace(convulsion,"NaN|99",replacement = NA_character_),
         snc_normal= str_replace(snc_normal,"NaN|99",replacement = NA_character_),
         disnea= str_replace(disnea,"NaN|99",replacement = NA_character_),
         resp_normal= str_replace(resp_normal,"NaN|99",replacement = NA_character_),
         glic_normal= str_replace(glic_normal,"NaN|99",replacement = NA_character_),
         hemoglobinuria= str_replace(hemoglobinuria,"NaN|99",replacement = NA_character_),
         anemia_severa= str_replace(anemia_severa,"NaN|99",replacement = NA_character_),
         renal_normal= str_replace(renal_normal,"NaN|99",replacement = NA_character_),
         hiperbil= str_replace(hiperbil,"NaN|99",replacement = NA_character_),
         hepato_normal= str_replace(hepato_normal,"NaN|99",replacement = NA_character_),
         ictericia= str_replace(ictericia,"NaN|99",replacement = NA_character_),
         malaria_pasado_num=  str_replace(malaria_pasado_num,"98|99",replacement = NA_character_),
         #fiebre_hoy_corr=  str_replace(fiebre_hoy_corr,"99",replacement = NA_character_),
         presenta_comorb= str_replace(presenta_comorb,"NaN|99",replacement = NA_character_), 
         sin_enf_cronica= str_replace(sin_enf_cronica,"NaN|99",replacement = NA_character_), 
         diabetes= str_replace(diabetes,"NaN|99",replacement = NA_character_), 
         enf_cardiac= str_replace(enf_cardiac,"NaN|99",replacement = NA_character_), 
         enf_pulm= str_replace(enf_pulm,"NaN|99",replacement = NA_character_), 
         enf_renal= str_replace(enf_renal,"NaN|99",replacement = NA_character_), 
         enf_snc= str_replace(enf_snc,"NaN|99",replacement = NA_character_),
         gingivorragia= str_replace(gingivorragia,"NaN|99",replacement = NA_character_), 
         epistaxis= str_replace(epistaxis,"NaN|99",replacement = NA_character_),
         coag_normal= str_replace(coag_normal,"NaN|99",replacement = NA_character_),
         cas_con_admin=  str_replace(cas_con_admin,"99",replacement = NA_character_)
         ) %>% 
  mutate(shock= as.double(shock),
         postracion=as.numeric(postracion), 
         confusion=as.numeric(confusion), 
         coma=as.numeric(coma), 
         convulsion=as.numeric(convulsion), 
         #snc_normal=as.numeric(snc_normal),
         sdra= as.double(sdra),
         disnea=as.numeric(disnea), 
         taquipnea=as.numeric(taquipnea), 
         infiltracion=as.numeric(infiltracion), 
         edema_pulm=as.numeric(edema_pulm), 
         #resp_normal=as.numeric(resp_normal),
         hiperbil= as.double(hiperbil),
         malaria_pasado_num= as.numeric(malaria_pasado_num),
         pa_sistolica= as.numeric(pa_sistolica),
         pa_diastolica= as.numeric(pa_diastolica),
         #fiebre_hoy_corr= as.numeric(fiebre_hoy_corr),
         presenta_comorb= as.numeric(presenta_comorb),
         sin_enf_cronica= as.numeric(sin_enf_cronica),
         diabetes=as.numeric(diabetes),
         enf_snc=as.numeric(enf_snc),
         enf_pulm=as.numeric(enf_pulm),
         enf_cardiac=as.numeric(enf_cardiac),
         enf_renal=as.numeric(enf_renal),
         gingivorragia= as.numeric(gingivorragia),
         epistaxis= as.numeric(epistaxis),
         cas_con_admin= as.numeric(cas_con_admin)
         ) %>% #glimpse()
  mutate(shock_oms_pa= if_else(pa_sistolica<=80,1,0),# OR shock==1
         snc_sum= rowSums(.[c(6:8,13)],na.rm = T),
         snc_oms=  if_else(snc_sum>0,1,0),
         glas_11= if_else(glasgow<=11 & glasgow>0,1,0),
         glas_oms= if_else(glasgow<=9,1,0),
         pulmonar_sum= rowSums(.[16:19],na.rm = T),
         pulmonar_oms=  if_else(pulmonar_sum>0,1,0),
         #sdra=  if_else(sdra!=1,0,1),
         hipoglic_oms= if_else(glucosa<40,1,0),
         anemia_oms= if_else(hemoglobina<7,1,0),
         renal_oms= if_else(creatinina>3,1,0),
         bilsum= rowSums(.[66:67],na.rm = T),
         hiperbil_oms= if_else(bilsum>2.5,1,0),
         enf_sum= rowSums(.[57:61],na.rm = T),
         enf_cronica= if_else(enf_sum>0,1,0),
         sangrado_sum= rowSums(.[27:29],na.rm = T),
         sangrado_new= if_else(sangrado_sum>0,1,0)
         #hiperbil_omsX= if_else(bilitot>2.5,1,0),
         #hiperbil_test= hiperbil_omsX==hiperbil_oms,
         ) %>% mutate(
           shock_oms= rowSums(.[c(25,72)],na.rm = T)# OR shock==1
         ) %>% glimpse()

#glimpse(sevdb_1)
#sevdb_1 %>% dplyr::count(malaria_pasado)
#sevdb_1 %>% group_by(admin_uci_corr,dias_uci) %>% dplyr::count()
#Hmisc::contents(sevdb_1)

#sevdb_1 %>% group_by(dx_admin1,dx_admin2,dx_admin3,dx_admin4,dx_admin5,dx_admin6) %>% dplyr::count()# %>% View()
#sevdb_1 %>% 
#  group_by(notx0,notx_1,notx_2,notx_3,notx_4,notx_5,notx_6,notx_7,notx_8,notx_9,notx_otro,notx_otro_esp) %>% 
#  dplyr::count()
#sevdb_1 %>% group_by(donde_tx1,dondetx2,donde_tx3,donde_tx4,donde_tx_otro,donde_tx_otro_esp) %>% dplyr::count()
#sevdb %>% group_by(pregnant,preg_malaria,preg_malaria_num,preg_resultado) %>% dplyr::count()
#sevdb_1 %>% group_by(pa_sistolic, pa_diastolic) %>% dplyr::count() %>% View()
```

#### Check updates

- **SHOCK**
    + menor o menor e igual a 80?
    + __inclusivo__ con casos definidos __sin__ `pa_sistolica` (únicos en Ab profile subset)

```{r}
#SHOCK
sevdb_1 %>% group_by(shock_oms, shock) %>% dplyr::count() #%>% View()
#sevdb_1 %>% group_by(shock_oms, shock, pa_sistolica, pa_diastolica) %>% dplyr::count() #%>% View()
sevdb_1 %>% select(pa_sistolica, pa_diastolica, shock_oms) %>%  
  #mutate(shock_oms= as.factor(shock_oms)) %>% 
  ggplot(aes(pa_sistolica, pa_diastolica, colour=shock_oms)) + 
  geom_vline(aes(xintercept=80))+
  #geom_histogram(alpha=.5, position = "identity") + 
  geom_point() + 
  scale_color_viridis() +
  labs(title="presion arterial")
```

- **GLASGOW**
    + menor a 9 o menor a 11?
    + heterogeneidad en data: 
        - valores finales sin valores de componentes
        - y viseversa
        - **requiere corrección**

```{r}
#GLASGOW -------------------------------------------------- CON INCONSISTENCIAS!!!
sevdb_1 %>% group_by(glas_oms, glas_11, glas_ojos, glas_verbal, glas_motor, glasgow) %>% dplyr::count()
sevdb_1 %>% group_by(glas_oms, glas_11) %>% dplyr::count()
```


- **CNS malaria**
    + postracion, coma, convulsion, confusion
```{r}
# CNS malaria = postracion, coma, convulcion, confusion
sevdb_1 %>% group_by(snc_oms, snc_sum, postracion, confusion, coma, convulsion, snc_normal) %>% dplyr::count()
```

- **LUNG_INJURY**
    + lung related-injuries (disnea, taquipnea, infiltracion, edema)
        + at least 2 criteria??
        + usado: at least one!!
    + definición de respiración normal?
    + diferencias entre `sdra` y `pulmonar_oms`
```{r}
# SDRA != LUNG_INJURY = at least 2 criteria of lung related-injuries (disnea, taquipnea, infiltracion, edema)
sevdb_1 %>% 
  group_by(pulmonar_oms, pulmonar_sum, disnea, taquipnea, infiltracion, edema_pulm, resp_normal) %>%  
  dplyr::count()

# RESPIRACION NORMAL vs FRECUENCIA RESPIRATORIA? -------------------------------------------------- REDEFINIR!!
sevdb_1 %>% group_by(resp_normal, frespiratoria) %>% dplyr::count()

# SDRA vs LUNG INJURY -------------------------------------------------- CONSISTENTE?
sevdb_1 %>% group_by(sdra, pulmonar_oms) %>%  dplyr::count()
```
- **SDRA**
    + __problema:__ valores son 1 y NA __¿corregir?__
```{r}
sevdb_1 %>% dplyr::count(sdra)
```

- ~~**BLEEDING**~~
    + ~~gingivorragia_corr, epistaxis_corr, sang_intest_corr~~
    + ~~at least one criteria~~
    + ~~`sangrado` con asignación incorrecta~~
```{r}
# BLEEDING -------------------------------------------------- REDEFINIR!!
#  = at least one criteria of bleeding (gingivorragia_corr, epistaxis_corr, sang_intest_corr)
sevdb_1 %>% 
  group_by(sangrado_new, sangrado_sum, sangrado, gingivorragia, epistaxis, sang_intest) %>%  
  dplyr::count()
```
- ~~**TROMBOCITOPENIA**~~
    + ~~puntos de corte~~
        - ~~severe trombocitopenia: menor de 50 000~~
        - ~~trombocitopenia: menor de 150 000~~
    + ~~`trombocitopenia` con asignacion incorrecta~~
```{r}
#TROMBOCITOPENIA?? -------------------------------------------------- REDEFINIR!!
sevdb_1 %>% 
  select(trombocitopenia, cont_plaquetas, coag_normal) %>% #dplyr::count()
  mutate(trombo_sev= if_else(cont_plaquetas<50000,1,0)) %>% 
  mutate(trombo_sev= as.factor(trombo_sev)) %>% #glimpse()
  ggplot(aes(x=cont_plaquetas, fill=trombo_sev)) + 
  geom_histogram(alpha=.5, position = "identity") + 
  labs(title="trombocitopenia")

sevdb_1 %>% 
  select(trombocitopenia, cont_plaquetas, coag_normal) %>% #dplyr::count()
  mutate(trombo_sev= if_else(cont_plaquetas<50000,1,0)) %>% 
  mutate(trombo_sev= as.factor(trombo_sev)) %>% #glimpse()
  group_by(trombo_sev, trombocitopenia, coag_normal) %>% 
  dplyr::count()
```

- **HIPOGLICEMIA**
    + `hipo_glic1`, `hipo_glic2`, qué determinan?
    + ningún hipoglicémico!
```{r}
# HIPOGLICEMIA
# glic_normal = hipo_glic1 + hipo_glic2 ????????
sevdb_1 %>% group_by(hipoglic_oms, glucosa, hipo_glic1, hipo_glic2, glic_normal) %>%  dplyr::count()
```

- **ANEMIA SEVERA**
    + `anemia_severa` no era consistente con los valores reales de `hemoglobina`
    + `anemia_oms` corrige error.

```{r}
# ANEMIA
sevdb_1 %>% group_by(anemia_oms, anemia_severa, hemoglobinuria, hemog_bajo, hto_bajo) %>%  dplyr::count()
sevdb_1 %>% group_by(anemia_oms, anemia_severa, hemoglobina) %>%  dplyr::count()
sevdb_1 %>% select(hto, hemoglobina,anemia_oms) %>%  
  ggplot(aes(hto, hemoglobina, colour=anemia_oms)) + 
  geom_point() + 
  geom_hline(aes(yintercept=7))+
  scale_color_viridis() +
  labs(title="hematocrito vs hemoglobina")
```

- **DAÑO RENAL**
    + `renal_normal` y `hipercreat` con asignación incorrecta

```{r}
# DAÑO RENAL
sevdb_1 %>% group_by(renal_oms, renal_normal, hipercreat, oliguria) %>%  dplyr::count()
sevdb_1 %>% group_by(renal_oms, renal_normal, hipercreat, creatinina) %>%  dplyr::count()
sevdb_1 %>% select(creatin_valor, creatinina, renal_oms) %>%  
  ggplot(aes(creatin_valor, creatinina, colour=renal_oms)) + 
  geom_point() + 
  geom_hline(aes(yintercept=3))+
  scale_color_viridis() +
  labs(title="creatin_valor vs creatinina")
```

- **HIPERBILIRRUBINA**
    + `ictericia` diferente a `hiperbili`
    + ambas con asignación incorrecta
    
```{r}
# HIPERBILIRRUBINA
#sevdb_1 %>% group_by(hiperbil_oms, hiperbil_omsX) %>% dplyr::count()

sevdb_1 %>% select(hiperbil_oms) %>% dplyr::count(hiperbil_oms)

sevdb_1 %>% 
  group_by(hiperbil_oms, hiperbil, bilirrubina, bilitot, bilind, bildirect) %>%  
  dplyr::count() #%>% View()

sevdb_1 %>% 
  group_by(hiperbil_oms, hiperbil, ictericia, hepato_normal) %>%  
  dplyr::count() #%>% View()
```

- **COMORBILITIES** 
    + diabetes, enf_cardiac, enf_pulm, enf_renal, enf_snc, enf_otra
    
```{r}
# COMORBIDITIES
sevdb_1 %>% 
  group_by(presenta_comorb, enf_cronica, sin_enf_cronica, diabetes, enf_cardiac, enf_pulm, enf_renal, enf_snc) %>% 
  dplyr::count()
```

### Filter WHO criteria

Según @WHO2014severe:

- **create** `sev_WHO`
    + **includes:** 
        + `glas_11`, `sdra`, `lung_injury`, `ictericia_corr`, `hiperbil`, `shock`, `bleeding`, `glic_normal`, `hiperparasitemia`, `anemia_severa`.
    + **Not** included `cns_malaria`
    + **differs** from `cas_con_admin2`

- deberia incluir como **renal impairment / failure**:
    + `hemoglobinuria_corr`
    + `oliguria_corr`

- referenciales:
    + `eritro_parasit`
    + `admin_uci_corr`, `dias_uci`
    + `fiebre_hoy_corr`
    + `presenta_comorb`
    + `malaria_pasado`, `malaria_pasado_num`

```{r}
sevdb_2 <- sevdb_1 %>% 
  select(1:4,
         shock_oms,glas_oms,snc_oms,pulmonar_oms,sdra,
         hipoglic_oms,anemia_oms,renal_oms,hiperbil_oms,
         #sangrado, trombocitpenia, hiperparasitemia,
         presenta_comorb,enf_cronica,parasitemia,
         malaria_pasado_num,casecontrol
         ) %>% 
  mutate(sev_WHO_num= rowSums(.[5:13],na.rm = T),
         sev_WHO= if_else(sev_WHO_num>0,"severo","no-severo"),
         malaria_pasado=if_else(malaria_pasado_num>0,"con-episodio-previo","sin-episodio-previo")
         ) %>%
  mutate(malaria_pasado= as.factor(malaria_pasado),
         sev_WHO= as.factor(sev_WHO),
         casecontrol= as.factor(casecontrol)#,anemia_oms= as.numeric(anemia_oms)
         ) %>% glimpse()
```

- **PACIENTE SEVERO**
```{r}
# CLASIFICACION PACIENTE SEVERO
sevdb_2 %>% group_by(sev_WHO, casecontrol, cas_con_admin#, criticos, cerebral2, criticalnopros#, dx_admin1
                   ) %>%  dplyr::count() #%>% View()

sevdb_2 %>% dplyr::count(sev_WHO)
sevdb_2 %>% group_by(cas_con_admin, sev_WHO) %>% dplyr::count()
sevdb_2 %>% group_by(casecontrol, sev_WHO) %>% dplyr::count()
```


- **EPISODIOS PREVIOS**
```{r}
# MALARIA PASADO (EPISODIOS PREVIOS)
sevdb_2 %>% group_by(malaria_pasado_num, malaria_pasado) %>% dplyr::count()
sevdb_2 %>% dplyr::count(malaria_pasado)
sevdb_2 %>% group_by(malaria_pasado, sev_WHO) %>% dplyr::count()
```

#### reduced dictionary
```{r}
html(Hmisc::contents(sevdb_2), maxlevels=10, levelType='table')
#glimpse(sevdb_2)
```

#### proportions per criteria

```{r}
s1 <- Hmisc::summaryM(shock_oms +
                        glas_oms +
                        snc_oms +
                        pulmonar_oms +
                        sdra +
                        #lab
                        hipoglic_oms +
                        anemia_oms +
                        renal_oms +
                        hiperbil_oms +
                        #presenta_comorb+
                        #enf_cronica
                        #parasitemia + 
                        sev_WHO_num
                      ~ sev_WHO
                      ,
               data=sevdb_2,
               overall=FALSE, test=FALSE)

latex(s1, caption='Laboratory data',
      exclude1=TRUE, npct='both', 
      digits=3,
      prmsd=TRUE, brmsd=TRUE, msdsize=mu$smaller2, #NOT-EVALUATE if PDF
      middle.bold=TRUE, long = TRUE,
      #legend.bottom = TRUE, #insert.bottom = TRUE, 
      what="%", html = TRUE
      ) #change here for LaTeX PDF
```

#### combination of criterias

```{r}
# SUM SEVERITY CRITERIAS
#sevdb_o <- sevdb_2 %>% 
#  dplyr::rename(glas=glas_11,
#         #sdra,
#         lung=lung_injury,
#         icter=ictericia_corr,
#         bili=hiperbil,
#         #shock,
#         bleed=bleeding,
#         glic=glic_normal,
#         paras=hiperparasitemia,
#         anemia=anemia_severa#, 
#         #hemo=hemoglobinuria_corr
#         ) 
sevdb_2 %>% 
  group_by(shock_oms,glas_oms,snc_oms,pulmonar_oms,sdra,
           hipoglic_oms,anemia_oms,renal_oms,hiperbil_oms#,sev_WHO
           ) %>% 
  dplyr::count() %>% 
  dplyr::arrange(desc(n))
```

```{r}
sevdb_2 %>% 
  select(shock_oms,glas_oms,snc_oms,pulmonar_oms,sdra,
         hipoglic_oms,anemia_oms,renal_oms,hiperbil_oms
           ) %>% 
  summarise_all(sum,na.rm=T) #%>% t()
```

```{r, fig.height=4, fig.width=6, fig.align='center', eval=FALSE}
## symptoms x exposure

#plot(sevdb_2$malaria_pasado_num,sevdb_2$sev_WHO_num)
sevdb_2 %>% 
  group_by(malaria_pasado_num, sev_WHO_num) %>%
  dplyr::summarise(n=n()) %>%
  mutate(prop= n/sum(n)) %>%
  ggplot(aes(malaria_pasado_num, sev_WHO_num, colour=n)) + 
  geom_point() + 
  scale_color_viridis() +
  labs(title="sevdb_2")
```

### Inferential statistics

- Joint `parasitemia` from `28Nov2014_Ed.dta` **[WARNING]**

```{r, eval=FALSE}
sevdb_x <- haven::read_dta("data-raw/malaria severa 28Nov2014_Ed.dta") %>% 
  select(codigo, parasitemia)%>% 
  mutate(codigo= str_replace(codigo,"LIM0","LIM"))

sevdb_2x <- sevdb_2 %>% 
  haven::as_factor() %>% 
  dplyr::inner_join(sevdb_x,by="codigo")
```

***

**wrt severity**

- significant differences with respect to 
    + proportion of previous episodes of malaria,
    + proportion of women patients towards severe cases

```{r}
s1 <- Hmisc::summaryM(edad + sexo +
                        presenta_comorb + enf_cronica +
                        parasitemia +
                        malaria_pasado + malaria_pasado_num #+ 
                        #sev_WHO + sev_WHO_num +
                      ~ sev_WHO #+ 
                      #malaria_pasado
                      ,
               data=sevdb_2,
               overall=FALSE, test=TRUE)

latex(s1, caption='Clinical data',
      exclude1=TRUE, npct='both', 
      digits=3,
      prmsd=TRUE, brmsd=TRUE, msdsize=mu$smaller2, #NOT-EVALUATE if PDF
      middle.bold=TRUE, long = TRUE,
      #legend.bottom = TRUE, #insert.bottom = TRUE, 
      what="%", html = TRUE
      ) #change here for LaTeX PDF

```

***

**wrt previouse episodes of malaria**

- significant differences with respect to 
    + mean age,
    + proportion of severe patients

```{r}
s1 <- Hmisc::summaryM(edad + sexo +
                        presenta_comorb + enf_cronica +
                        parasitemia +
                        #malaria_pasado_num + #malaria_pasado +
                        sev_WHO + sev_WHO_num #+
                      ~ #sev_WHO #+ 
                      malaria_pasado
                      ,
               data=sevdb_2,
               overall=FALSE, test=TRUE)

latex(s1, caption='Clinical data',
      exclude1=TRUE, npct='both', 
      digits=3,
      prmsd=TRUE, brmsd=TRUE, msdsize=mu$smaller2, #NOT-EVALUATE if PDF
      middle.bold=TRUE, long = TRUE,
      #legend.bottom = TRUE, #insert.bottom = TRUE, 
      what="%", html = TRUE
      ) #change here for LaTeX PDF
```

***

**wrt severity by previous episodes of malaria**

- no significant differences with respect to any variable

```{r}
s1 <- Hmisc::summaryM(edad + sexo +
                        presenta_comorb + enf_cronica +
                        parasitemia #+
                        #malaria_pasado_num + #malaria_pasado +
                        #sev_WHO_num #+ sev_WHO
                      ~ sev_WHO + 
                      malaria_pasado
                      ,
               data=sevdb_2,
               overall=FALSE, test=TRUE)

latex(s1, caption='Clinical data',
      exclude1=TRUE, npct='both', 
      digits=3,
      prmsd=TRUE, brmsd=TRUE, msdsize=mu$smaller2, #NOT-EVALUATE if PDF
      middle.bold=TRUE, long = TRUE,
      #legend.bottom = TRUE, #insert.bottom = TRUE, 
      what="%", html = TRUE
      ) #change here for LaTeX PDF
```

```{r, fig.width=6, fig.height=5, fig.align='center'}
#plot(s1, which='categorical')
#Key(0,0)
```

```{r, fig.width=8, fig.height=4, fig.align='center'}
#par(mfrow=c(1,2))
#plot(s1, which='continuous')
#par(mfrow=c(1,1))
```


## Ab profile subset

- **60 samples** from the Severe study dataset.

```{r}
subsev <- data_frame(
  codigo= c( "LIM2048", "LIM1025", "LIM1029", "LIM2035", "LIM1043", "LIM2017", "LIM1054", 
             "LIM2102", "LIM2010", "LIM1038", "LIM2050", "LIM2115", "LIM2043", "LIM1004", 
             "LIM2030", "LIM2071", "LIM1035", "LIM2104", "LIM1051", "LIM2107", "LIM1062", 
             "LIM2072", "LIM2074", "LIM1056", "LIM1050", "LIM2110", "LIM2026", "LIM1047", 
             "LIM1057", "LIM1016", "LIM1063", "LIM1044", "LIM2044", "LIM1037", "LIM2007", 
             "LIM2086", "LIM2042", "LIM2101", "LIM1045", "LIM2085", "LIM1048", "LIM2066", 
             "LIM2067", "LIM1021", "LIM2077", "LIM1061", "LIM2056", "LIM2034", "LIM2016", 
             "LIM2111", "LIM1030", "LIM2096", "LIM1064", "LIM2093", "LIM1041", "LIM2040", 
             "LIM1052", "LIM2013", "LIM1059", "LIM2089"),
  abnomic= TRUE
)

sevdb_3 <- dplyr::inner_join(sevdb_2,subsev, by="codigo")
#html(Hmisc::contents(sevdb_3), maxlevels=10, levelType='table')

sevdb_3 %>% group_by(malaria_pasado, malaria_pasado_num) %>% dplyr::count()
sevdb_3 %>% dplyr::count(malaria_pasado)
sevdb_3 %>% dplyr::count(sev_WHO)
#sevdb_3 %>% group_by(cas_con_admin2, sev_WHO) %>% dplyr::count()
sevdb_3 %>% group_by(malaria_pasado, sev_WHO) %>% dplyr::count()

#sevdb_3 %>% group_by(admin_uci_corr,dias_uci) %>% dplyr::count()
#sevdb_3 %>% group_by(sdra,lung_injury) %>%  dplyr::count()
#sevdb_3 %>% group_by(ictericia_corr,hiperbil) %>%  dplyr::count()
#sevdb_3 %>% group_by(anemia_severa, hemoglobinuria_corr) %>%  dplyr::count()
```

- Joint `parasitemia` from `28Nov2014_Ed.dta` **[WARNING]**

```{r, eval=FALSE}
sevdb_4 <- sevdb_3 %>% 
  dplyr::inner_join(sevdb_x, by="codigo")
#html(Hmisc::contents(sevdb_4), maxlevels=10, levelType='table')
```
```{r, eval=FALSE}
d <- describe(sevdb_4)
html(d, size=90, scroll=TRUE)
```


```{r, eval=FALSE}
# THIS IS IN eval=FALSE !!!!!!!
sevdb_4 <- sevdb_3 %>% 
  haven::as_factor() %>%
  mutate_at(vars(-c(1:7),-ends_with("_num"),-abnomic), as.factor) %>% 
  mutate(admin_uci_corr= fct_recode(admin_uci_corr,NULL="No sabe"),
         ictericia_corr= fct_recode(ictericia_corr,NULL="No sabe"),
         cns_malaria= fct_recode(cns_malaria,"Si"="1", "No"="0"),
         glas_11= fct_recode(glas_11,"Si"="1", "No"="0"),
         sdra= fct_recode(sdra,"Si"="1", "No"="0"),
         lung_injury= fct_recode(lung_injury,"Si"="1", "No"="0"),
         hiperbil= fct_recode(hiperbil,"Si"="1", "No"="0"),
         shock= fct_recode(shock,"Si"="1", "No"="0"),
         bleeding= fct_recode(bleeding,"Si"="1", "No"="0"),
         glic_normal= fct_recode(glic_normal,"Si"="1", "No"="0"),
         hiperparasitemia= fct_recode(hiperparasitemia,"Si"="1", "No"="0"),
         anemia_severa= fct_recode(anemia_severa,"Si"="1", "No"="0"),
         presenta_comorb= fct_recode(presenta_comorb,"Si"="1", "No"="0")) %>% 
  dplyr::inner_join(sevdb_x)

html(Hmisc::contents(sevdb_4), maxlevels=10, levelType='table')
```

### proportions per criteria

```{r}
s1 <- Hmisc::summaryM(shock_oms +
                        glas_oms +
                        snc_oms +
                        pulmonar_oms +
                        sdra +
                        #lab
                        hipoglic_oms +
                        anemia_oms +
                        renal_oms +
                        hiperbil_oms +
                        #presenta_comorb+
                        #enf_cronica
                        #parasitemia + 
                        sev_WHO_num
                      ~ sev_WHO
                      ,
               data=sevdb_3,
               overall=FALSE, test=FALSE)

latex(s1, caption='Laboratory data',
      exclude1=TRUE, npct='both', 
      digits=3,
      prmsd=TRUE, brmsd=TRUE, msdsize=mu$smaller2, #NOT-EVALUATE if PDF
      middle.bold=TRUE, long = TRUE,
      #legend.bottom = TRUE, #insert.bottom = TRUE, 
      what="%", html = TRUE
      ) #change here for LaTeX PDF
```

### combinations of criterias
```{r}
# SUM SEVERITY CRITERIAS
#sevdb_o <- sevdb_2 %>% 
#  dplyr::rename(glas=glas_11,
#         #sdra,
#         lung=lung_injury,
#         icter=ictericia_corr,
#         bili=hiperbil,
#         #shock,
#         bleed=bleeding,
#         glic=glic_normal,
#         paras=hiperparasitemia,
#         anemia=anemia_severa#, 
#         #hemo=hemoglobinuria_corr
#         ) 
sevdb_3 %>% 
  group_by(shock_oms,glas_oms,snc_oms,pulmonar_oms,sdra,
           hipoglic_oms,anemia_oms,renal_oms,hiperbil_oms#,sev_WHO
           ) %>% 
  dplyr::count() %>% 
  dplyr::arrange(desc(n))
```
```{r}
sevdb_3 %>% 
  select(shock_oms,glas_oms,snc_oms,pulmonar_oms,sdra,
         hipoglic_oms,anemia_oms,renal_oms,hiperbil_oms
           ) %>% 
  summarise_all(sum,na.rm=T) #%>% t()
```


### Descriptive statistics

- Joint `parasitemia` from `28Nov2014_Ed.dta` **[WARNING]**

```{r, eval=FALSE}
sevdb_x <- haven::read_dta("data-raw/malaria severa 28Nov2014_Ed.dta") %>% 
  select(codigo, parasitemia)%>% 
  mutate(codigo= str_replace(codigo,"LIM0","LIM"))

sevdb_3x <- sevdb_3 %>% 
  haven::as_factor() %>% 
  dplyr::inner_join(sevdb_x,by="codigo")
```

***

**wrt severity**

- significant differences with respect to 
    + proportion of previous episodes of malaria,
    + proportion of women patients towards severe cases

```{r}
s1 <- Hmisc::summaryM(edad + sexo +
                        #presenta_comorb + 
                        enf_cronica +
                        parasitemia +
                        malaria_pasado + malaria_pasado_num #+ 
                        #sev_WHO + sev_WHO_num +
                      ~ sev_WHO #+ 
                      #malaria_pasado
                      ,
               data=sevdb_3,
               overall=FALSE, test=FALSE)

latex(s1, caption='Clinical data',
      exclude1=TRUE, npct='both', 
      digits=3,
      prmsd=TRUE, brmsd=TRUE, msdsize=mu$smaller2, #NOT-EVALUATE if PDF
      middle.bold=TRUE, long = TRUE,
      #legend.bottom = TRUE, #insert.bottom = TRUE, 
      what="%", html = TRUE
      ) #change here for LaTeX PDF

```

***

**wrt previouse episodes of malaria**

- significant differences with respect to 
    + mean age,
    + proportion of severe patients

```{r}
s1 <- Hmisc::summaryM(edad + sexo +
                        #presenta_comorb + 
                        enf_cronica +
                        parasitemia +
                        #malaria_pasado_num + #malaria_pasado +
                        sev_WHO + sev_WHO_num #+
                      ~ #sev_WHO #+ 
                      malaria_pasado
                      ,
               data=sevdb_3,
               overall=FALSE, test=FALSE)

latex(s1, caption='Clinical data',
      exclude1=TRUE, npct='both', 
      digits=3,
      prmsd=TRUE, brmsd=TRUE, msdsize=mu$smaller2, #NOT-EVALUATE if PDF
      middle.bold=TRUE, long = TRUE,
      #legend.bottom = TRUE, #insert.bottom = TRUE, 
      what="%", html = TRUE
      ) #change here for LaTeX PDF
```

***

**wrt severity by previous episodes of malaria**

- no significant differences with respect to any variable

```{r}
s1 <- Hmisc::summaryM(edad + sexo +
                        #presenta_comorb + 
                        enf_cronica +
                        parasitemia #+
                        #malaria_pasado_num + #malaria_pasado +
                        #sev_WHO_num #+ sev_WHO
                      ~ sev_WHO + 
                      malaria_pasado
                      ,
               data=sevdb_3,
               overall=FALSE, test=FALSE)

latex(s1, caption='Clinical data',
      exclude1=TRUE, npct='both', 
      digits=3,
      prmsd=TRUE, brmsd=TRUE, msdsize=mu$smaller2, #NOT-EVALUATE if PDF
      middle.bold=TRUE, long = TRUE,
      #legend.bottom = TRUE, #insert.bottom = TRUE, 
      what="%", html = TRUE
      ) #change here for LaTeX PDF
```

```{r, fig.width=6, fig.height=5, fig.align='center'}
#plot(s1, which='categorical')
#Key(0,0)
```

```{r, fig.width=8, fig.height=4, fig.align='center'}
#par(mfrow=c(1,2))
#plot(s1, which='continuous')
#par(mfrow=c(1,1))
```


<!-- CORREGIR / EVALUAR -->

```{r, fig.height=4, fig.width=6, fig.align='center', eval=FALSE}
## symptoms x exposure

#plot(sevdb_3$malaria_pasado_num,sevdb_3$sev_WHO_num)
sevdb_3 %>% 
  group_by(malaria_pasado_num, sev_WHO_num) %>%
  dplyr::summarise(n=n()) %>%
  mutate(prop= n/sum(n)) %>%
  ggplot(aes(malaria_pasado_num, sev_WHO_num, colour=n)) + 
  geom_point() + 
  scale_color_viridis() +
  labs(title="sevdb_3")
```

```{r, eval=FALSE}
# **On severity**
s1 <- Hmisc::summaryM(edad + sexo +
                        malaria_pasado + #malaria_pasado_num + 
                        #sev_WHO_num #+ sev_WHO
                        fiebre_hoy_corr + presenta_comorb +
                        parasitemia #+
                      ~ sev_WHO #+ 
                      #malaria_pasado
                      ,
               data=sevdb_4,
               overall=FALSE, test=FALSE)

latex(s1, caption='Clinical data',
      exclude1=TRUE, npct='both', 
      digits=3,
      prmsd=TRUE, brmsd=TRUE, msdsize=mu$smaller2, #NOT-EVALUATE if PDF
      middle.bold=TRUE, long = TRUE,
      #legend.bottom = TRUE, #insert.bottom = TRUE, 
      what="%", html = TRUE
      ) #change here for LaTeX PDF
```

```{r, eval=FALSE}
s1 <- Hmisc::summaryM(glas_11 +
                        sdra +
                        lung_injury +
                        ictericia_corr + hiperbil +
                        shock +
                        bleeding +
                        glic_normal +
                        anemia_severa +
                        hiperparasitemia + #parasitemia + 
                        sev_WHO_num +
                        fiebre_hoy_corr
                      ~ sev_WHO
                      ,
               data=sevdb_4,
               overall=FALSE, test=FALSE)

latex(s1, caption='Laboratory data',
      exclude1=TRUE, npct='both', 
      digits=3,
      prmsd=TRUE, brmsd=TRUE, msdsize=mu$smaller2, #NOT-EVALUATE if PDF
      middle.bold=TRUE, long = TRUE,
      #legend.bottom = TRUE, #insert.bottom = TRUE, 
      what="%", html = TRUE
      ) #change here for LaTeX PDF
```

```{r, eval=FALSE}
# **On previous episodes of malaria**
s1 <- Hmisc::summaryM(edad + sexo + 
                        #malaria_pasado_num + #malaria_pasado +
                        sev_WHO + sev_WHO_num +
                        fiebre_hoy_corr + presenta_comorb +
                        parasitemia #+
                      ~ #sev_WHO #+ 
                      malaria_pasado
                      ,
               data=sevdb_4,
               overall=FALSE, test=FALSE)

latex(s1, caption='Clinical data',
      exclude1=TRUE, npct='both', 
      digits=3,
      prmsd=TRUE, brmsd=TRUE, msdsize=mu$smaller2, #NOT-EVALUATE if PDF
      middle.bold=TRUE, long = TRUE,
      #legend.bottom = TRUE, #insert.bottom = TRUE, 
      what="%", html = TRUE
      ) #change here for LaTeX PDF
```
```{r, eval=FALSE}
s1 <- Hmisc::summaryM(glas_11 +
                        sdra +
                        lung_injury +
                        ictericia_corr + hiperbil +
                        shock +
                        bleeding +
                        glic_normal +
                        anemia_severa +
                        hiperparasitemia + #parasitemia + 
                        sev_WHO_num +
                        fiebre_hoy_corr
                      ~ #sev_WHO #+ 
                      malaria_pasado
                      ,
               data=sevdb_4,
               overall=FALSE, test=FALSE)

latex(s1, caption='Laboratory data',
      exclude1=TRUE, npct='both', 
      digits=3,
      prmsd=TRUE, brmsd=TRUE, msdsize=mu$smaller2, #NOT-EVALUATE if PDF
      middle.bold=TRUE, long = TRUE,
      #legend.bottom = TRUE, #insert.bottom = TRUE, 
      what="%", html = TRUE
      ) #change here for LaTeX PDF
```

```{r, eval=FALSE}
#**On severity by previous episodes of malaria**
s1 <- Hmisc::summaryM(edad + sexo +
                        #malaria_pasado_num + #malaria_pasado +
                        #sev_WHO_num #+ sev_WHO
                        fiebre_hoy_corr + presenta_comorb +
                        parasitemia #+
                      ~ sev_WHO + 
                      malaria_pasado
                      ,
               data=sevdb_4,
               overall=FALSE, test=FALSE)

latex(s1, caption='Clinical data',
      exclude1=TRUE, npct='both', 
      digits=3,
      prmsd=TRUE, brmsd=TRUE, msdsize=mu$smaller2, #NOT-EVALUATE if PDF
      middle.bold=TRUE, long = TRUE,
      #legend.bottom = TRUE, #insert.bottom = TRUE, 
      what="%", html = TRUE
      ) #change here for LaTeX PDF
```

```{r, eval=FALSE}
s1 <- Hmisc::summaryM(glas_11 +
                        sdra +
                        lung_injury +
                        ictericia_corr + hiperbil +
                        shock +
                        bleeding +
                        glic_normal +
                        anemia_severa +
                        hiperparasitemia + #parasitemia + 
                        sev_WHO_num +
                        fiebre_hoy_corr
                      ~ sev_WHO + 
                      malaria_pasado
                      ,
               data=sevdb_4,
               overall=FALSE, test=FALSE)

latex(s1, caption='Laboratory data',
      exclude1=TRUE, npct='both', 
      digits=3,
      prmsd=TRUE, brmsd=TRUE, msdsize=mu$smaller2, #NOT-EVALUATE if PDF
      middle.bold=TRUE, long = TRUE,
      #legend.bottom = TRUE, #insert.bottom = TRUE, 
      what="%", html = TRUE
      ) #change here for LaTeX PDF
```

```{r, fig.width=7, fig.height=6, fig.align='center'}
#plot(s1, which='categorical')
#Key(0,0)
```

```{r, fig.width=8, fig.height=4, fig.align='center'}
#par(mfrow=c(1,2))
#plot(s1, which='continuous')
#par(mfrow=c(1,1))
```

```{r, eval=FALSE}
# appendix
bpplt()
```

# References